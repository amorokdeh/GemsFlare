stages:
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: >-
    -Dhttps.protocols=TLSv1.2
    -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository
    -Dorg.slf4j.simpleLogger.showDateTime=true
    -Djava.awt.headless=true

  MAVEN_CLI_OPTS: >-
    --batch-mode
    --errors
    --fail-at-end
    --show-version
    --no-transfer-progress
    -DinstallAtEnd=true
    -DdeployAtEnd=true

  GOOGLE_PROJECT_ID: "gems-flare"
  IMAGE_NAME: "gems-flare-backend"
  REGION: "europe-west1"
  SERVICE_NAME: "gems-flare-backend"
  DOCKER_IMAGE: "gcr.io/$GOOGLE_PROJECT_ID/$IMAGE_NAME"

cache:
  paths:
    - .m2/repository

# Build Stage
build:
  stage: build
  image: eclipse-temurin:23-jdk-alpine  # Fixed: Using a valid Java 23 base image
  before_script:
    - apk add --no-cache maven  # Fixed: Install Maven manually
  script:
    - echo "Building the project..."
    - mvn clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

# Test Stage
test:
  stage: test
  image: eclipse-temurin:23-jdk-alpine  # Fixed: Using a valid Java 23 base image
  before_script:
    - apk add --no-cache maven  # Fixed: Install Maven manually
  script:
    - echo "Running unit tests..."
    - mvn test

# Deploy Stage
deploy:
  stage: deploy
  image: google/cloud-sdk:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "Authenticating with Google Cloud..."
    - echo $GOOGLE_APPLICATION_CREDENTIALS | base64 --decode > /tmp/key.json
    - gcloud auth activate-service-account --key-file=/tmp/key.json
    - gcloud config set project $GOOGLE_PROJECT_ID
    - gcloud auth configure-docker
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE .
    - echo "Pushing Docker image to Google Artifact Registry..."
    - docker push $DOCKER_IMAGE
    - echo "Deploying to Google Cloud Run..."
    - gcloud run deploy $SERVICE_NAME --image $DOCKER_IMAGE --platform managed --region $REGION --allow-unauthenticated
  only:
    - main
